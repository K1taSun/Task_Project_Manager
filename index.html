<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menadżer zadań</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --bg: #f6f8fa;
      --bg-dark: #181a1b;
      --card: #fff;
      --card-dark: #23272f;
      --text: #222;
      --text-dark: #f7fafc;
      --border: #e5e7eb;
      --border-dark: #2d323b;
      --shadow: 0 2px 12px rgba(30,64,175,0.08);
      --radius: 18px;
      --transition: 0.18s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"] {
      --primary: #60a5fa;
      --primary-dark: #2563eb;
      --bg: var(--bg-dark);
      --card: var(--card-dark);
      --text: var(--text-dark);
      --border: var(--border-dark);
    }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
    }
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      height: 64px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0; z-index: 10;
    }
    .navbar .logo {
      font-weight: 700;
      font-size: 1.3em;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navbar .logo .material-icons {
      font-size: 1.4em;
      color: var(--primary);
    }
    .navbar .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .navbar button, .navbar select {
      background: none;
      border: none;
      color: var(--primary-dark);
      font-size: 1.1em;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: var(--radius);
      transition: background var(--transition), color var(--transition);
    }
    .navbar button:hover, .navbar select:hover {
      background: var(--primary);
      color: #fff;
    }
    .navbar .theme-btn {
      font-size: 1.3em;
      color: var(--primary-dark);
      background: none;
      border: none;
      margin-left: 8px;
    }
    .layout {
      display: flex;
      min-height: calc(100vh - 64px);
      transition: all var(--transition);
    }
    .sidebar {
      width: 270px;
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 24px 0 24px 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
      transition: background var(--transition);
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px 6px 24px;
      font-weight: 600;
      font-size: 1.08em;
    }
    .sidebar-list {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 0 8px 0 8px;
    }

    .project-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      margin: 4px 0;
      border-radius: 12px;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
      color: var(--text);
      background: transparent;
    }
    .project-item:hover {
      background: var(--primary);
      color: #fff;
    }
    .project-item.selected {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }

    .project-item .count {
      font-size: 0.95em;
      color: var(--primary-dark);
      background: #e0e7ff;
      border-radius: 8px;
      padding: 2px 8px;
      margin-left: 8px;
    }
    .project-item.selected .count {
      background: #fff3;
      color: #fff;
    }
    .project-item .actions {
      display: flex;
      gap: 4px;
    }
    .project-item .actions button {
      font-size: 1.1em;
      color: var(--primary-dark);
      background: none;
      border: none;
      border-radius: 8px;
      padding: 2px 6px;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
    }
    .project-item .actions button:hover {
      background: var(--primary);
      color: #fff;
    }
    .add-project-btn {
      margin: 0 24px;
      padding: 10px 0;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 1.08em;
      cursor: pointer;
      transition: background var(--transition);
    }
    .add-project-btn:hover {
      background: var(--primary-dark);
    }
    .main {
      flex: 1 1 auto;
      padding: 32px 32px 32px 32px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-width: 0;
    }
    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .filters input, .filters select {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1.5px solid var(--border);
      background: #f3f6fa;
      font-size: 1.05rem;
      outline: none;
      min-width: 90px;
      color: var(--text);
      transition: background var(--transition), color var(--transition);
      flex: 1 1 auto;
    }
    [data-theme="dark"] .filters input, [data-theme="dark"] .filters select {
      background: #23272f;
      color: #f7fafc;
    }
    .tasks-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
      width: 100%;
    }
    .tasks-list.compact {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .task-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 20px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      border: 1.5px solid var(--border);
      transition: box-shadow var(--transition), border var(--transition), background var(--transition);
      min-width: 0;
    }
    .task-card.done {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .task-card.compact {
      padding: 12px 16px;
    }
    @media (max-width: 768px) {
      .task-card.compact {
        padding: 10px 12px;
      }
    }
    @media (max-width: 480px) {
      .task-card.compact {
        padding: 8px 10px;
      }
    }
    .task-card.compact.done .title {
      text-decoration: line-through;
    }
    .task-card .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .task-card .title {
      font-weight: 600;
      font-size: 1.13em;
      flex: 1 1 auto;
      word-break: break-word;
    }
    .task-card .description {
      font-size: 0.95em;
      color: #666;
      line-height: 1.4;
      margin: 4px 0;
      word-break: break-word;
      max-height: 4.2em;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      cursor: pointer;
      transition: max-height var(--transition);
      padding: 4px;
      border-radius: 6px;
    }
    .task-card .description:hover {
      background: rgba(0,0,0,0.05);
    }
    [data-theme="dark"] .task-card .description:hover {
      background: rgba(255,255,255,0.05);
    }
    .task-card .description.expanded {
      max-height: none;
      -webkit-line-clamp: unset;
    }
    [data-theme="dark"] .task-card .description {
      color: #aaa;
    }
    .task-card .tags {
      font-size: 0.98em;
      color: var(--primary-dark);
      margin-right: 8px;
      opacity: 0.8;
    }
    .task-card .meta {
      font-size: 0.97em;
      color: #888;
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 2px;
    }
    .task-card .actions {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .task-card .actions button {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.2em;
      color: var(--primary-dark);
      border-radius: 8px;
      padding: 4px 8px;
      transition: background var(--transition), color var(--transition);
    }
    .task-card .actions button:hover {
      background: var(--primary);
      color: #fff;
    }
    .fab {
      position: fixed;
      right: 32px;
      bottom: 32px;
      width: 64px;
      height: 64px;
      background: var(--primary);
      color: #fff;
      border-radius: 50%;
      box-shadow: 0 4px 24px rgba(30,64,175,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2em;
      border: none;
      cursor: pointer;
      z-index: 100;
      transition: background var(--transition), box-shadow var(--transition);
    }
    .fab:hover {
      background: var(--primary-dark);
      box-shadow: 0 8px 32px rgba(30,64,175,0.22);
    }
    /* Modal */
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      min-width: 400px;
      max-width: 500px;
      width: 90vw;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 24px 20px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
      border: 1.5px solid var(--border);
      animation: modalSlideIn 0.2s ease-out;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    .modal h2 {
      margin: 0 0 12px 0;
      font-size: 1.2em;
      font-weight: 600;
    }
    .modal label {
      font-size: 0.95em;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text);
    }
    .modal input, .modal select, .modal textarea {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f3f6fa;
      font-size: 0.95rem;
      outline: none;
      margin-bottom: 8px;
      color: var(--text);
      transition: background var(--transition), color var(--transition), border var(--transition);
      font-family: inherit;
      resize: vertical;
    }
    .modal input:focus, .modal select:focus, .modal textarea:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    [data-theme="dark"] .modal input:focus, [data-theme="dark"] .modal select:focus, [data-theme="dark"] .modal textarea:focus {
      background: #2a2f3a;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
    }
    .modal textarea {
      min-height: 60px;
      line-height: 1.4;
    }
    [data-theme="dark"] .modal input, [data-theme="dark"] .modal select, [data-theme="dark"] .modal textarea {
      background: #23272f;
      color: #f7fafc;
    }
    .modal .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
    }
    .modal .modal-actions button {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-size: 0.9em;
      transition: background var(--transition);
    }
    .modal .modal-actions button.cancel {
      background: #e0e0e0;
      color: #222;
    }
    .modal .close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.2em;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 3;
      padding: 4px;
      border-radius: 4px;
      transition: background var(--transition);
    }
    .modal .close:hover {
      background: rgba(0,0,0,0.1);
    }
    @media (max-width: 1200px) {
      .main { padding: 24px 3vw 24px 3vw; }
      .sidebar { width: 220px; }
      .tasks-list {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
      }
    }
    @media (max-width: 1100px) {
      .main { padding: 20px 3vw 20px 3vw; }
      .sidebar { width: 200px; }
      .tasks-list {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
      }
    }
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .sidebar { 
        width: 100%; 
        border-right: none; 
        border-bottom: 1px solid var(--border);
        padding: 16px 0;
      }
      .main { padding: 16px 3vw 16px 3vw; }
      .fab { right: 20px; bottom: 20px; }
      .filters {
        gap: 8px;
      }
      .filters input, .filters select {
        min-width: 80px;
        font-size: 1rem;
        padding: 8px 12px;
      }
      .tasks-list {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }
    }
    @media (max-width: 768px) {
      .navbar { padding: 0 16px; }
      .navbar .logo { font-size: 1.2em; }
      .main { padding: 12px 4vw 12px 4vw; }
      .filters {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .filters input, .filters select {
        min-width: auto;
        width: 100%;
      }
      .tasks-list {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .task-card {
        padding: 16px 14px 12px 14px;
      }
      .fab { 
        right: 16px; 
        bottom: 16px; 
        width: 56px;
        height: 56px;
        font-size: 2em;
      }
    }
    @media (max-width: 600px) {
      .navbar { padding: 0 12px; }
      .navbar .logo { font-size: 1.1em; }
      .main { padding: 8px 3vw 8px 3vw; }
      .sidebar-header, .add-project-btn { margin: 0 12px; }
      .task-card {
        padding: 14px 12px 10px 12px;
      }
      .modal { 
        padding: 16px 12px 12px 12px; 
        min-width: 95vw;
        max-width: 95vw;
        gap: 8px;
      }
      .modal h2 { font-size: 1.1em; margin-bottom: 8px; }
      .modal input, .modal select, .modal textarea { 
        padding: 6px 10px; 
        font-size: 0.9rem;
        margin-bottom: 6px;
      }
      .modal .modal-actions button { 
        padding: 6px 12px; 
        font-size: 0.85em;
      }
    }
    @media (max-width: 480px) {
      .navbar { padding: 0 8px; }
      .navbar .logo { font-size: 1em; }
      .navbar .logo .material-icons {
        font-size: 1.2em;
      }
      .navbar .actions button {
        padding: 4px 8px;
        font-size: 1em;
      }
      .navbar .actions {
        gap: 6px;
      }
      .main { padding: 6px 2vw 6px 2vw; }
      .sidebar-header, .add-project-btn { margin: 0 8px; }
      .task-card {
        padding: 12px 10px 8px 10px;
      }
      .task-card .title {
        font-size: 1.1em;
      }
      .task-card .description {
        font-size: 0.9em;
      }
      .fab { 
        right: 12px; 
        bottom: 12px; 
        width: 52px;
        height: 52px;
        font-size: 1.8em;
      }
    }
    @media (max-width: 400px) {
      .modal { 
        min-width: 98vw; 
        max-width: 98vw;
        padding: 12px 8px 8px 8px;
      }
      .task-card {
        padding: 10px 8px 6px 8px;
      }
      .task-card .title {
        font-size: 1.05em;
      }
    }
    /* Landscape orientation on mobile */
    @media (max-width: 900px) and (orientation: landscape) {
      .layout { flex-direction: row; }
      .sidebar { 
        width: 200px; 
        border-right: 1px solid var(--border);
        border-bottom: none;
        padding: 16px 0;
      }
      .main { padding: 12px 3vw 12px 3vw; }
      .filters {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .tasks-list {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    
    /* Hide view text on small screens */
    @media (max-width: 480px) {
      .view-text {
        display: none;
      }
      #toggleView {
        padding: 8px !important;
        min-width: 40px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo"><span class="material-icons">dashboard_customize</span> Menadżer zadań</div>
    <div class="actions">
      <button onclick="exportData('json')" title="Eksportuj JSON"><span class="material-icons">download</span></button>
      <button onclick="exportData('csv')" title="Eksportuj CSV"><span class="material-icons">table_view</span></button>
      <button class="theme-btn" onclick="toggleTheme()" title="Zmień motyw"><span class="material-icons">dark_mode</span></button>
    </div>
  </nav>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <span>Projekty</span>
        <button class="material-icons" onclick="showProjectModal()" title="Dodaj projekt">add</button>
      </div>
      <div class="sidebar-list" id="projectsList"></div>
      <button class="add-project-btn" onclick="showProjectModal()">+ Nowy projekt</button>
    </aside>
    <main class="main">
      <div id="projectDetails"></div>
      <div class="filters">
        <label for="filterSearch" style="display:none">Szukaj</label>
        <input type="text" id="filterSearch" placeholder="Szukaj w tytule i opisie..." oninput="renderTasks()">
        <label for="filterTag" style="display:none">Tag</label>
        <input type="text" id="filterTag" placeholder="Tag..." oninput="renderTasks()">
        <label for="filterPriority" style="display:none">Priorytet</label>
        <select id="filterPriority" onchange="renderTasks()">
          <option value="">Priorytet</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
        <label for="filterDeadline" style="display:none">Deadline</label>
        <input type="date" id="filterDeadline" onchange="renderTasks()">
        <button id="toggleView" onclick="toggleView()" style="background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.9em;white-space:nowrap;">
          <span class="material-icons" style="font-size:1em;vertical-align:middle;">view_list</span> <span class="view-text">Widok</span>
        </button>
      </div>
      <div class="tasks-list" id="tasksList"></div>
    </main>
  </div>
  <button class="fab" onclick="showTaskModal()" title="Dodaj zadanie"><span class="material-icons">add</span></button>
  <div id="modalRoot"></div>
  <script>
    const API = "http://localhost:8080";
    let projects = [];
    let tasks = [];
    let selectedProject = null;
    let editingProject = null;
    let editingTask = null;
    let compactView = false; // Nowa zmienna do śledzenia widoku

    // Motyw
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      document.querySelector('.theme-btn .material-icons').textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      setTheme(current === 'dark' ? 'light' : 'dark');
    }
    // Inicjalizacja motywu
    (function() {
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(theme);
    })();

    // Projekty
    async function fetchProjects() {
      const res = await fetch(`${API}/projects`);
      
      projects = await res.json();
      renderProjects();
      renderProjectDetails();
    }
    function renderProjects() {
      const list = document.getElementById('projectsList');
      list.innerHTML = '';
      
      // Sortuj projekty alfabetycznie
      const sortedProjects = [...projects].sort((a, b) => a.name.localeCompare(b.name));
      
      if (sortedProjects.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.style.cssText = 'text-align:center;padding:20px;color:#888;font-style:italic;';
        emptyDiv.textContent = 'Brak projektów';
        list.appendChild(emptyDiv);
        return;
      }
      
      sortedProjects.forEach(p => {
        const div = document.createElement('div');
        div.className = 'project-item' + (selectedProject === p.id ? ' selected' : '');
        div.innerHTML = `<span>${p.name}</span><span class="count">${tasks.filter(t=>t.project_id===p.id).length}</span>`;
        div.onclick = () => { selectedProject = p.id; renderProjects(); renderTasks(); renderProjectDetails(); };
        div.oncontextmenu = (e) => {
          e.preventDefault();
          showProjectModal(p);
        };
        // Dodaj tooltip z informacją o prawym kliku
        div.title = `Prawy klik: Edytuj projekt`;
        list.appendChild(div);
      });
    }
    function renderProjectDetails() {
      const details = document.getElementById('projectDetails');
      if (!selectedProject) {
        details.innerHTML = `
          <div style="background:var(--card);border-radius:16px;padding:40px 22px;margin-bottom:18px;box-shadow:var(--shadow);border:1.5px solid var(--border);text-align:center;color:#888;">
            <span class="material-icons" style="font-size:3em;display:block;margin-bottom:10px;opacity:0.5;">folder_open</span>
            <div style="font-size:1.1em;">Wybierz projekt z listy po lewej stronie</div>
          </div>
        `;
        return;
      }
      const project = projects.find(p => p.id === selectedProject);
      if (!project) {
        details.innerHTML = '';
        return;
      }
      const count = tasks.filter(t => t.project_id === project.id).length;
      details.innerHTML = `
        <div style="background:var(--card);border-radius:16px;padding:18px 22px;margin-bottom:18px;box-shadow:var(--shadow);border:1.5px solid var(--border);display:flex;align-items:center;gap:18px;">
          <span class="material-icons" style="font-size:2em;color:var(--primary);">folder</span>
          <div style="flex:1;">
            <div style="font-size:1.18em;font-weight:600;">${project.name}</div>
            <div style="color:#888;font-size:0.98em;">Zadań: ${count}</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button title='Dodaj zadanie do projektu' onclick='showTaskModal(null, ${project.id})' style='background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;'><span class="material-icons">add_task</span></button>
            <button title='Edytuj projekt' onclick='showProjectModal(projects.find(p=>p.id===${project.id}))' style='background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;'><span class="material-icons">edit</span></button>
            <button title='Usuń projekt' onclick='deleteProject(${project.id})' style='background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;'><span class="material-icons">delete</span></button>
          </div>
        </div>
      `;
    }
    async function saveProject() {
      const name = document.getElementById('projectName').value.trim();
      if (!name) return alert('Nazwa projektu jest wymagana!');
      try {
        let res;
        if (editingProject) {
          res = await safeFetch(`${API}/projects/${editingProject.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...editingProject, name })
          });
        } else {
          res = await safeFetch(`${API}/projects`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
          });
          // Automatycznie wybierz nowy projekt
          const newProject = await res.json();
          selectedProject = newProject.id;
        }
        closeModal();
        await fetchProjects();
      } catch (error) {
        console.error("Failed to save project:", error);
      }
    }

    // Zadania
    async function fetchTasks() {
      const res = await fetch(`${API}/tasks`);
      tasks = await res.json();
      renderTasks();
    }
    function renderTasks() {
      renderProjectDetails();
      const list = document.getElementById('tasksList');
      list.innerHTML = '';
      list.className = 'tasks-list' + (compactView ? ' compact' : '');
      let filtered = tasks;
      if (selectedProject) filtered = filtered.filter(t => t.project_id === selectedProject);
      
      const search = document.getElementById('filterSearch').value.trim().toLowerCase();
      if (search) filtered = filtered.filter(t => 
        t.title.toLowerCase().includes(search) || 
        (t.description && t.description.toLowerCase().includes(search))
      );
      
      const tag = document.getElementById('filterTag').value.trim();
      if (tag) filtered = filtered.filter(t => (t.tags||[]).some(tg => tg.toLowerCase().includes(tag.toLowerCase())));
      const prio = document.getElementById('filterPriority').value;
      if (prio) filtered = filtered.filter(t => t.priority === prio);
      const deadline = document.getElementById('filterDeadline').value;
      if (deadline) filtered = filtered.filter(t => t.deadline && t.deadline.startsWith(deadline));
      filtered.sort((a,b) => {
        if (!a.deadline && !b.deadline) return 0;
        if (!a.deadline) return 1;
        if (!b.deadline) return -1;
        return new Date(a.deadline) - new Date(b.deadline);
      });
      if (filtered.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.style.cssText = 'grid-column:1/-1;text-align:center;padding:40px;color:#888;font-style:italic;background:var(--card);border-radius:var(--radius);border:1.5px solid var(--border);';
        emptyDiv.innerHTML = '<span class="material-icons" style="font-size:3em;display:block;margin-bottom:10px;opacity:0.5;">assignment</span>Brak zadań';
        list.appendChild(emptyDiv);
        return;
      }
      
      filtered.forEach(t => {
        const card = document.createElement('div');
        card.className = 'task-card' + (t.done ? ' done' : '') + (compactView ? ' compact' : '');
        
        if (compactView) {
          // Widok kompaktowy - lista
          card.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;width:100%;">
              <button title="${t.done ? 'Oznacz jako niewykonane' : 'Oznacz jako wykonane'}" onclick="toggleDone(${t.id})" style="background:none;border:none;cursor:pointer;color:var(--primary);">
                <span class="material-icons">${t.done ? 'check_box' : 'check_box_outline_blank'}</span>
              </button>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:600;font-size:1.1em;margin-bottom:4px;">${t.title}</div>
                ${t.description ? `<div style="font-size:0.9em;color:#666;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.description}</div>` : ''}
                <div style="display:flex;gap:8px;align-items:center;font-size:0.9em;color:#888;">
                  ${t.deadline ? `<span><span class="material-icons" style="font-size:1em;vertical-align:middle;">event</span> ${t.deadline.substring(0,10)}</span>` : ''}
                  ${t.priority ? `<span><span class="material-icons" style="font-size:1em;vertical-align:middle;">flag</span> ${t.priority}</span>` : ''}
                  ${(t.tags||[]).length > 0 ? `<span style="color:var(--primary);">${(t.tags||[]).join(', ')}</span>` : ''}
                </div>
              </div>
              <div style="display:flex;gap:4px;">
                <button title="Edytuj" onclick="showTaskModal(tasks.find(x=>x.id===${t.id}))" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:4px;color:var(--primary);">
                  <span class="material-icons">edit</span>
                </button>
                <button title="Usuń" onclick="deleteTask(${t.id})" style="background:none;border:none;cursor:pointer;padding:4px;border-radius:4px;color:var(--primary);">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </div>
          `;
        } else {
          // Widok kart
          card.innerHTML = `
            <div class="row">
              <span class="title">${t.title}</span>
              <span class="tags">${(t.tags||[]).join(', ')}</span>
            </div>
            ${t.description ? `<div class="description" onclick="toggleDescription(this)" title="Kliknij aby rozwinąć">${t.description}</div>` : ''}
            <div class="meta">
              ${t.deadline ? `<span class="material-icons" style="font-size:1em;vertical-align:middle;">event</span> ${t.deadline.substring(0,10)}` : ''}
              ${t.priority ? `<span class="material-icons" style="font-size:1em;vertical-align:middle;">flag</span> Priorytet: ${t.priority}` : ''}
              <span>${t.done ? '<span class="material-icons" style="color:var(--primary)">check_circle</span> Wykonane' : ''}</span>
            </div>
            <div class="actions">
              <button title="Edytuj" onclick="showTaskModal(tasks.find(x=>x.id===${t.id}))"><span class="material-icons">edit</span></button>
              <button title="Usuń" onclick="deleteTask(${t.id})"><span class="material-icons">delete</span></button>
              <button title="${t.done ? 'Oznacz jako niewykonane' : 'Oznacz jako wykonane'}" onclick="toggleDone(${t.id})"><span class="material-icons">${t.done ? 'check_box' : 'check_box_outline_blank'}</span></button>
            </div>
          `;
        }
        
        list.appendChild(card);
      });
    }
    async function saveTask() {
      const title = document.getElementById('taskTitle').value.trim();
      const description = document.getElementById('taskDescription').value.trim();
      const projectId = document.getElementById('taskProject').value ? parseInt(document.getElementById('taskProject').value) : null;
      const tags = document.getElementById('taskTags').value.split(',').map(x=>x.trim()).filter(Boolean);
      const priority = parseInt(document.getElementById('taskPriority').value) || 0;
      const deadline = document.getElementById('taskDeadline').value;
      if (!title) return alert('Tytuł zadania jest wymagany!');
      let payload = {
        title,
        description,
        tags,
        priority,
        deadline: deadline ? new Date(deadline).toISOString() : null,
        done: editingTask ? editingTask.done : false,
        project_id: editingTask ? editingTask.project_id : projectId
      };
      try {
        let res;
        if (editingTask) {
          res = await safeFetch(`${API}/tasks/${editingTask.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...editingTask, ...payload })
          });
        } else {
          res = await safeFetch(`${API}/tasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          // Automatycznie wybierz projekt dla nowego zadania
          const newTask = await res.json();
          if (newTask.project_id && !selectedProject) {
            selectedProject = newTask.project_id;
          } else if (newTask.project_id) {
            selectedProject = newTask.project_id;
          }
        }
        closeModal();
        await fetchTasks();
      } catch (error) {
        console.error("Failed to save task:", error);
      }
    }
    async function deleteTask(id) {
      if (!confirm('Na pewno usunąć zadanie?')) return;
      try {
        await safeFetch(`${API}/tasks/${id}`, { method: 'DELETE' });
        await fetchTasks();
      } catch (error) {
        console.error("Failed to delete task:", error);
      }
    }
    async function deleteProject(id) {
      if (!confirm('Na pewno usunąć projekt?')) return;
      try {
        await safeFetch(`${API}/projects/${id}`, { method: 'DELETE' });
        // Natychmiast usuń projekt i powiązane zadania z frontu
        projects = projects.filter(p => p.id !== id);
        tasks = tasks.filter(t => t.project_id !== id);
        if (selectedProject === id) selectedProject = null;
        renderProjects();
        renderProjectDetails();
        renderTasks();
        // Opcjonalnie odśwież dane z backendu w tle
        await fetchProjects();
        await fetchTasks();
      } catch (error) {
        console.error("Failed to delete project:", error);
      }
    }
    // Modale
    function showProjectModal(project) {
      editingProject = project;
      const modal = document.createElement('div');
      modal.className = 'modal-bg';
      modal.innerHTML = `
        <div class="modal">
          <button class="close" onclick="closeModal()"><span class="material-icons">close</span></button>
          <h2>${project ? 'Edytuj projekt' : 'Nowy projekt'}</h2>
          <label for="projectName">Nazwa</label>
          <input id="projectName" value="${project ? project.name : ''}" maxlength="40">
          <div class="modal-actions">
            <button class="cancel" onclick="closeModal()">Anuluj</button>
            <button onclick="saveProject()">Zapisz</button>
          </div>
        </div>
      `;
      document.getElementById('modalRoot').appendChild(modal);
    }
    function showTaskModal(task, projectId = null) {
      editingTask = task;
      // Jeśli podano projectId, użyj go jako domyślnego projektu
      if (projectId && !task) {
        selectedProject = projectId;
      }
      const modal = document.createElement('div');
      modal.className = 'modal-bg';
      modal.innerHTML = `
        <div class="modal">
          <button class="close" onclick="closeModal()"><span class="material-icons">close</span></button>
          <h2>${task ? 'Edytuj zadanie' : 'Nowe zadanie'}</h2>
          <label for="taskProject">Projekt</label>
          <select id="taskProject">
            <option value="">Brak projektu</option>
            ${projects.map(p => `<option value="${p.id}" ${(task ? task.project_id : selectedProject) === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
          </select>
          <label for="taskTitle">Tytuł</label>
          <input id="taskTitle" value="${task ? task.title : ''}" maxlength="60">
          <label for="taskDescription">Opis (opcjonalny)</label>
          <textarea id="taskDescription" rows="3" placeholder="Dodaj szczegółowy opis zadania..." maxlength="1000" oninput="updateCharCount()">${task ? (task.description || '') : ''}</textarea>
          <div id="charCount" style="text-align:right;font-size:0.8em;color:#888;margin-top:-6px;margin-bottom:8px;">0/1000</div>
          <label for="taskTags">Tagi (przecinek)</label>
          <input id="taskTags" value="${task ? (task.tags||[]).join(', ') : ''}">
          <label for="taskPriority">Priorytet</label>
          <select id="taskPriority">
            <option value="">Brak</option>
            <option value="1" ${task && task.priority===1?'selected':''}>1</option>
            <option value="2" ${task && task.priority===2?'selected':''}>2</option>
            <option value="3" ${task && task.priority===3?'selected':''}>3</option>
            <option value="4" ${task && task.priority===4?'selected':''}>4</option>
            <option value="5" ${task && task.priority===5?'selected':''}>5</option>
          </select>
          <label for="taskDeadline">Deadline (opcjonalny)</label>
          <input type="date" id="taskDeadline" value="${task && task.deadline ? task.deadline.substring(0,10) : ''}">
          <div class="modal-actions">
            <button class="cancel" onclick="closeModal()">Anuluj</button>
            <button onclick="saveTask()">Zapisz</button>
          </div>
        </div>
      `;
      document.getElementById('modalRoot').appendChild(modal);
      // Inicjalizuj licznik znaków
      setTimeout(updateCharCount, 100);
    }
    function closeModal() {
      document.getElementById('modalRoot').innerHTML = '';
      setTimeout(() => {
        editingProject = null;
        editingTask = null;
      }, 0);
    }
    // Eksport
    function exportData(format) {
      window.open(`${API}/export?format=${format}`);
    }
    // Funkcja do rozwijania opisu
    function toggleDescription(element) {
      element.classList.toggle('expanded');
    }
    
    // Funkcja do aktualizacji licznika znaków
    function updateCharCount() {
      const textarea = document.getElementById('taskDescription');
      const charCount = document.getElementById('charCount');
      if (textarea && charCount) {
        const length = textarea.value.length;
        const maxLength = textarea.maxLength;
        charCount.textContent = `${length}/${maxLength}`;
        charCount.style.color = length > maxLength * 0.9 ? '#e74c3c' : '#888';
      }
    }
    
    // Funkcja do przełączania widoku
    function toggleView() {
      compactView = !compactView;
      const button = document.getElementById('toggleView');
      const isSmallScreen = window.innerWidth <= 480;
      if (compactView) {
        button.innerHTML = '<span class="material-icons" style="font-size:1em;vertical-align:middle;">view_module</span>' + (isSmallScreen ? '' : '<span class="view-text">Karty</span>');
      } else {
        button.innerHTML = '<span class="material-icons" style="font-size:1em;vertical-align:middle;">view_list</span>' + (isSmallScreen ? '' : '<span class="view-text">Lista</span>');
      }
      renderTasks();
    }
    
    // Dodaj funkcję toggleDone jeśli nie istnieje
    function toggleDone(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      task.done = !task.done;
      saveTaskStatus(task);
    }
    async function saveTaskStatus(task) {
      try {
        await safeFetch(`${API}/tasks/${task.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(task)
        });
        await fetchTasks();
      } catch (error) {
        console.error("Failed to save task status:", error);
        // Przywróć poprzedni stan
        task.done = !task.done;
        renderTasks();
      }
    }
    // Inicjalizacja
    let ws = null;
    
    function connectWebSocket() {
      try {
        ws = new WebSocket("ws://localhost:8080/ws");
        ws.onmessage = function(event) {
          if (event.data === "update") {
            fetchProjects();
            fetchTasks();
          }
        };
        ws.onclose = function() {
          console.log("WebSocket connection closed, attempting to reconnect...");
          setTimeout(connectWebSocket, 3000);
        };
        ws.onerror = function(error) {
          console.error("WebSocket error:", error);
        };
      } catch (error) {
        console.error("Failed to connect WebSocket:", error);
        setTimeout(connectWebSocket, 3000);
      }
    }
    
    // Dodaj obsługę błędów dla fetch
    async function safeFetch(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response;
      } catch (error) {
        console.error("Fetch error:", error);
        alert(`Błąd połączenia: ${error.message}`);
        throw error;
      }
    }
    
    // Zaktualizuj funkcje fetch
    async function fetchProjects() {
      try {
        const res = await safeFetch(`${API}/projects`);
        projects = await res.json();
        renderProjects();
        renderProjectDetails();
      } catch (error) {
        console.error("Failed to fetch projects:", error);
      }
    }
    
    async function fetchTasks() {
      try {
        const res = await safeFetch(`${API}/tasks`);
        tasks = await res.json();
        renderTasks();
      } catch (error) {
        console.error("Failed to fetch tasks:", error);
      }
    }
    
    // Obsługa zmiany rozmiaru okna
    window.addEventListener('resize', function() {
      const button = document.getElementById('toggleView');
      if (button) {
        const isSmallScreen = window.innerWidth <= 480;
        const currentText = compactView ? 'Karty' : 'Lista';
        const icon = compactView ? 'view_module' : 'view_list';
        button.innerHTML = '<span class="material-icons" style="font-size:1em;vertical-align:middle;">' + icon + '</span>' + (isSmallScreen ? '' : '<span class="view-text">' + currentText + '</span>');
      }
    });
    
    connectWebSocket();
    Promise.all([fetchProjects(), fetchTasks()]);
  </script>
</body>
</html> 